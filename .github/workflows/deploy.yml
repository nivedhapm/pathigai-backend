name: Deploy Spring Boot to Droplet

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java 21
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Deploy to Droplet via SSH
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.DROPLET_IP }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: 22
          envs: SPRING_DATASOURCE_URL,SPRING_DATASOURCE_USERNAME,SPRING_DATASOURCE_PASSWORD,JWT_SECRET,EMAIL_USER,EMAIL_PASSWORD,FAST2SMS_API_KEY,FAST2SMS_SENDER_ID,RECAPTCHA_SITE_KEY,RECAPTCHA_SECRET_KEY,CORS_ALLOWED_ORIGINS
          script: |
            cd /home/deploy/pathigai-backend
            git fetch origin
            git reset --hard origin/main
            
            chmod +x deploy-start.sh
            
            echo "Executing deploy-start.sh..."
            ./deploy-start.sh
        env:
          SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/pathigai_app?useSSL=false&serverTimezone=UTC
          SPRING_DATASOURCE_USERNAME: ${{ secrets.DB_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.DB_PASSWORD }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          CORS_ALLOWED_ORIGINS: https://pathigai.vercel.app,http://localhost:3000,http://localhost:5173,http://localhost:5174,https://64.227.142.243
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          FAST2SMS_API_KEY: ${{ secrets.FAST2SMS_API_KEY }}
          FAST2SMS_SENDER_ID: ${{ secrets.FAST2SMS_SENDER_ID }}
          RECAPTCHA_SITE_KEY: ${{ secrets.RECAPTCHA_SITE_KEY }}
          RECAPTCHA_SECRET_KEY: ${{ secrets.RECAPTCHA_SECRET_KEY }}